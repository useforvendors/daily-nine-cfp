<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Read</title>
<style>
  :root { --bg: #f4f1eb; --text: #3b372f; --muted: #8a8373; }
  html,body { height:100%; }
  body {
    margin:0; padding:20px; font-family: Palatino, serif;
    background: linear-gradient(to bottom, #d4d0c5 0%, #c5c0b5 100%);
    color:var(--text);
    display:flex; flex-direction:column; gap:16px;
  }
  header {
    display:flex; align-items:center; gap:12px;
  }
  header a { text-decoration:none; color:var(--muted); font-size:0.95rem; }
  header h1 { margin:0; font-size:1.25rem; font-weight:400; letter-spacing:8px; text-transform:lowercase; }
  #meta { font-size:0.95rem; color:var(--muted); }
  #frame-wrap { flex:1 1 auto; min-height:0; }
  iframe {
    width:100%; height:100%; border:0; background:white; box-shadow:0 2px 8px rgba(0,0,0,0.06);
  }
  .fallback {
    padding:18px; background:#fff; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.04);
  }
  .btn { display:inline-block; margin-top:8px; padding:8px 12px; border-radius:6px; text-decoration:none; background:#3b372f; color:#fff; }
</style>
</head>
<body>
  <header>
    <a href="/" aria-label="Back to home">← home</a>
    <div>
      <h1>read</h1>
      <div id="meta">loading…</div>
    </div>
  </header>

  <div id="frame-wrap" role="main">
    <div id="loading" class="fallback">Preparing reader view…</div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const target = params.get('url');

    if (!target) {
      document.getElementById('frame-wrap').innerHTML =
        '<div class="fallback">No article URL provided. <a href="/" class="btn">Back</a></div>';
      document.title = 'Invalid URL';
      throw new Error('Missing url param');
    }

    // Build the Textise URL
    const textise = 'https://textise.net/showtext.aspx?strURL=' + encodeURIComponent(target);

    // Update meta and document title
    document.getElementById('meta').textContent = target;
    document.title = 'Read — ' + (new URL(target)).hostname;

    // Create iframe
    const iframe = document.createElement('iframe');
    iframe.src = textise;
    iframe.loading = 'eager';
    iframe.allow = ''; // keep empty unless you need to allow specific features
    iframe.title = 'Reader view of ' + target;

    // Replace loading with iframe. Some sites block framing (X-Frame-Options); we'll detect that below.
    const wrap = document.getElementById('frame-wrap');
    wrap.innerHTML = '';
    wrap.appendChild(iframe);

    // Fallback handler: detect if iframe blocked by checking height after timeout
    const checkTimeout = setTimeout(async () => {
      try {
        // Try to access iframe document height — will throw if cross-origin or blocked.
        const h = iframe.contentWindow && iframe.contentWindow.document && iframe.contentWindow.document.body.scrollHeight;
        // if h is falsy or small, still show fallback after outro.
        if (!h || h < 50) showFallback();
      } catch (err) {
        // Accessing iframe.contentWindow.document will throw for cross-origin or blocked frames.
        // Many sites intentionally block embedding with X-Frame-Options or CSP — handle gracefully.
        showFallback();
      }
    }, 1500);

    function showFallback() {
      clearTimeout(checkTimeout);
      // Remove iframe to show clean fallback message
      if (iframe.parentNode) iframe.parentNode.removeChild(iframe);

      wrap.innerHTML = `
        <div class="fallback">
          <p>We couldn't embed the article (the site blocks framing). You can:</p>
          <ul>
            <li><a href="${textise}" target="_blank" rel="noopener">Open the text-only view (Textise)</a></li>
            <li><a href="${target}" target="_blank" rel="noopener">Open the original article</a></li>
          </ul>
          <p style="margin-top:12px;color:var(--muted)">If many sites block embedding, we can add a small server proxy to fetch and return Textise content from the server side.</p>
        </div>
      `;
    }

    // Also, optional: if the iframe fires an error event, show fallback
    iframe.addEventListener('error', () => {
      showFallback();
    });

  </script>
</body>
</html>
